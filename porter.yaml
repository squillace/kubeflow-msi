# This is the configuration for Porter
# You must define steps for each action, but the rest is optional
# See https://porter.sh/author-bundles for documentation on how to configure your bundle
# Uncomment out the sections below to take full advantage of what Porter can do!

name: kubeflow
version: 0.1.9
description: "A bundle that installs, tests, and uninstalls Kubeflow on AKS using MSI and specifying custom UI metadata for use with Azure integration. "
# TODO: update the registry to your own, e.g. myregistry
registry: ghcr.io/squillace

# If you want to customize the Dockerfile in use, uncomment the line below and update the referenced file. 
# See https://porter.sh/custom-dockerfile/
dockerfile: Dockerfile.tmpl

mixins:
  - exec
  - kubernetes
  - kfctl

install:
  - exec:
      description: "Acquiring the cluster name...."
      command: kubectl
      arguments:
        - "config"
        - "view"
      flags:
        minify: ""
        o: "jsonpath={.clusters}"
      outputs:
        - name: cluster
          regex: "(\\w*)"

  - exec:
      command: swap-names.sh
      description: "Detecting whether we're inside a cluster..."
      suppress-output: false
      arguments:
        - "{{bundle.outputs.cluster}}"

  - exec:
      command: istioctl
      description: "Initializing Istio...."
      suppress-output: false
      arguments:
        - operator
        - init

  - exec:
      command: bash
      description: "Creating the ingress namespace."
      flags:
          c: '"kubectl create ns istio-system --dry-run -o yaml | kubectl apply -f -"' 

  - kubernetes:
      description: "Installing the istio components..."
      manifests:
        - "istio.aks.yaml"
      validate: true
      wait: true

  - exec:
      description: "Acquiring the cluster name...."
      command: kubectl
      arguments:
        - "config"
        - "view"
      flags:
        minify: ""
        o: "jsonpath={.clusters}"
      outputs:
        - name: cluster
          regex: "(\\w*)"

  - exec:
      command: swap-names.sh
      description: "Detecting whether we're inside a cluster..."
      suppress-output: false
      arguments:
        - "{{bundle.outputs.cluster}}"


  - exec:
      command: sed
      description: "Configuring the Kubeflow deployment with the cluster name..."
      suppress-output: true
      arguments:
        - "'s/  clusterName: cncf/  clusterName: cluster.local/g'"
        - v1.2-deployment/kfctl_azure.v1.2.0.yaml
      flags:
        i: ""

  - exec:
      command: sed
      description: "Configuring the Kubeflow deployment with the cluster name..."
      suppress-output: true
      arguments:
        - "'s/  clusterName: cncf/  clusterName: {{bundle.outputs.cluster}}/g'"
        - v1.2-deployment/kfctl_azure.v1.2.0.yaml
      flags:
        i: ""

  - exec:
      command: bash
      description: "output"
      suppress-output: false
      flags:
        c: "'cat v1.2-deployment/kfctl_azure.v1.2.0.yaml'"

  - exec:
      command: bash
      description: "Deploying Kubeflow...."
      suppress-output: false
      flags:
        c: "'cd v1.2-deployment && kfctl apply -V -f kfctl_azure.v1.2.0.yaml'"

  - exec:
      command: zip
      description: "Capturing the Kustomize state..." 
      suppress-output: false
      outputs:
        - name: kustomize
          path: /cnab/app/v1.2-deployment/kustomize.zip
      arguments:
        - "/cnab/app/v1.2-deployment/kustomize.zip"
        - "/cnab/app/v1.2-deployment/kustomize"
      flags:
        r: ""
upgrade:
  - exec:
      description: "World 2.0"
      command: ./helpers.sh
      arguments:
        - upgrade

uninstall:
  - exec:
      command: unzip
      description: "Rehydrating the Kustomize state..." 
      suppress-output: false
      arguments:
        - "v1.2-deployment/kustomize.zip"

  - exec:
      description: "Acquiring the cluster name...."
      command: kubectl
      arguments:
        - "config"
        - "view"
      flags:
        minify: ""
        o: "jsonpath={.clusters[].name}"
      outputs:
        - name: cluster
          regex: "(\\w*)"

  - exec:
      command: sed
      description: "Configuring the Kubeflow deployment with the cluster name..."
      suppress-output: true
      arguments:
        - "'s/  clusterName: cncf/  clusterName: {{bundle.outputs.cluster}}/g'"
        - v1.2-deployment/kfctl_azure.v1.2.0.yaml
      flags:
        i: ""

  - exec:
      command: bash
      description: "Deleting the KubeFlow deployment...."
      suppress-output: false
      flags:
        c: "'cd v1.2-deployment && kfctl delete -f kfctl_azure.v1.2.0.yaml --verbose'"

  - kubernetes:
      description: "Deleting the istio components..."
      manifests:
        - "istio.aks.yaml"
      wait: true
  - exec:
      command: bash
      description: "Deleting the istio-system namespace."
      flags:
          c: '"kubectl create ns istio-system --dry-run -o yaml | kubectl delete -f -"' 


  - exec:
      command: istioctl
      description: "Initializing Istio...."
      suppress-output: false
      arguments:
        - operator
        - remove

outputs:
  - name: kustomize
    description: "A zip file of the kustomize generated state; reused automatically for the Uninstall action."
    type: file
    applyTo:
      - "install"
    path: /cnab/app/v1.2-deployment/kustomize.zip
  - name: cluster
    description: "The name of the cluster."
    type: string
    applyTo: 
      - install
      - uninstall


# Below is an example of how to define credentials
# See https://porter.sh/author-bundles/#credentials
credentials:
  - name: kubeconfig
    description: "The Kubernetes configuration file that has permission to connect to the AKS cluster to be configured."
    path: /root/.kube/config
    required: false


# Below is an example of how to define parameters
# See https://porter.sh/author-bundles/#parameters
parameters:

  - name: kustomize
    description: "This value is automatically pulled from the state of the bundle installation the uninstall operation is working against. You do not provide it yourself."
    type: file
    path: /cnab/app/v1.2-deployment/kustomize.zip
    applyTo:
      - "uninstall"
    source:
      output: kustomize

# The following values are consumed by the Azure Portal and turned into visual blades and UI elements.
custom:
  com.azure.creatuidef:
    blades:
      Kubernetes:
        displayOrder: 1
        label: Kubernetes Properties
    elements:
      - name: kubeconfig
        tooltip: A valid Kubernetes config for the Kuberentes cluster to install Kubeflow
        displayName: Kubernetes Configuration
        displayOrder: 1
        uitype: Microsoft.Common.TextBox
        bladename: Kubernetes
      - name: deploymentTime
        hide: true
      - name: cnab_installation_name
        displayOrder: 1
        tooltip: The CNAB Bundle installation name
        displayName: Installation Name
        bladename: Kubernetes
